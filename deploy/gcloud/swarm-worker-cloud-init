#cloud-config

coreos:
  units:
    - name: connect-to-docker-swarm.service
      command: start
      content: |
        [Unit]
        Description=Connect to the docker swarm master

        [Service]
        Type=OneShot
        ExecStartPre=/usr/bin/bash -c "/usr/bin/systemctl set-environment DOCKER_SWARM_TOKEN=$(curl \"http://metadata.google.internal/computeMetadata/v1/project/attributes/docker_swarm_token\" -H \"Metadata-Flavor: Google\")"
        ExecStart=/usr/bin/docker swarm join --token ${DOCKER_SWARM_TOKEN} swarm-manager:2377

        [Unit]
        Requires=docker.socket
